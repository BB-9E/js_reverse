from 抖音直播间弹幕.extractors.douyin_pb2 import PushFrame, Response, ChatMessage
import binascii
import gzip


def 解析直播间广播数据(content):
    # 将16进制转换成原始字节
    res_bytes = binascii.unhexlify(content)

    # 转成PushFrame数据对象
    frame = PushFrame()
    frame.ParseFromString(res_bytes)

    # 对PushFrame的 payload 内容进行gzip解压
    origin_bytes = gzip.decompress(frame.payload)

    # 根据Response+gzip解压数据，生成Response数据对象
    response = Response()
    response.ParseFromString(origin_bytes)

    msg_list = []
    for item in response.messagesList:
        if item.method != "WebcastChatMessage":
            continue
        # 生成ChatMessage数据对象
        message = ChatMessage()
        message.ParseFromString(item.payload)
        webcast_chat_message = {
            'user_id': message.user.id,
            'user_nickName': message.user.nickName,
            'content': message.content
        }
        msg_list.append(webcast_chat_message)
    return msg_list


if __name__ == '__main__':
    content = '082110acfbddb0e3b3cdd53018b84520082a150a0d636f6d70726573735f747970651204677a69702aca010a0f696d2d696e7465726e616c5f65787412b601696e7465726e616c5f7372633a707573687365727665727c7773735f6d73675f747970653a727c777264735f6b76733a496e70757450616e656c436f6d706f6e656e7453796e63446174612d313638373939353839363435353036343837325f57656263617374526f6f6d52616e6b4d6573736167652d313638383038393939323339303131313636325f57656263617374526f6f6d53746174734d6573736167652d313638383039303133303335333137393231322a400a09696d2d637572736f721233742d313638383039303133353230395f722d373235303239313932323532353234373537355f642d315f752d315f7264632d332a170a06696d2d6e6f77120d313638383039303133353230392a190a0e696d2d6c6976655f637572736f721207642d315f752d31320270623a036d736742c20d1f8b08000000000000ffec585b681cd719f6d915f27aecd8cbd6495515ca22f7c930d239731f41a97757176b2d59d2eab2d29272989d39bb1aedceec6466b417d9292105cbae6d24dc46348254c1511b47ad5be54614b5258e496929b86ea94b2114fa6245a2cd833094e6a1942259daa8ca865ab51253d8857958ceccff9ff39ffffbbe9f8f9af551813849aa8ae3464614b78b388e9226817feda7984a0bfe6bd79ef9db47372edfd6ea16a79fb973ee2fdfbead4130f4bd7be006783e1058acf54dde5efbf177fe7ecbe3ffe7cc9d5f3e561f585e985cfdd6f4f2dc2bcb73afacbef1aa2008411035a9ec88eb5a4e735393c5366ab9b1926e5abadaa8e68c26a5400cd284202c2208efffa395bce22a76939173145da5b324ada825cc22519020848851382125701ca7286ce3a845d25f4fd939e36b2c144441442ccbcd83716a603de17a3e812edc3fd68ebcba916eda5c691a73888dd3b6a2119c257992c5791e23a9d132d3df74ad6c9ece25471b754349933a7f300841f8cb7581862fae5e7e6975fec2caf50b2b4b2f236965e9e5e58b17577ef4e26be090ef6dafff278001b019c025f01e808119f08dcf74475701a6e2bb89bf51676c29a5cd244c11231e23b9528643c14310dc0414e56ba8a56a7cfb02fb9ef5ec7bcd73b0a82b394b31d3fdfdd17b9eceae3eaed0391a0a8742a190e9b60e32ae1be9e13a398c84c1829238857b623cc2793de588f6487ba24f1a55b03cded1d2d7798a1fa5fb625d7454d21324331a17a20b5eef5fbd8ff00ea76ac0d59a0aadfc9b9af6fbc73c5d6c6db389ce0d586e319eeb691f1b8b31d1feee74bec8c7c78b193e34dc59b287068668cb4a652d5c6885ad3da4433532e32ddd3dc3e15e581f5c9b9df8e9daecc49b6bb313d7d666275edf7cde599b9d585a9b9d588c26a927a9dead0ab00f5881ac9224596c9202564714b7c2e98fef3fd6126989b48582cc09509cfef0a3b9da6b80a92be39cba132c1341a79e215b0cf17a907adf5f69c5ff8be93f7db87073074584e7fcd4e3762e67e0ac9e2158cd1946cec42e29ba812f9c81cdeb5b7d3a7806353baead9be9a7eb0f53078ea5367fc1296fc3ad23be83f3e05747a8f78ef8962f4e4d5ef2faafbff5fb576beb0fafcd5e3abffe2c2f4c2e2f5e0a7aa2ef7aa9b3657641e8c1e9c5cd39b46ad23a0d25c4aa1022ac2685648ac829c2a7448ec8aa2ca420cb8850501489839250916da833ff0bb7ed7d72e1734f1e68dfa3e8f3e096e763b43f68af7f02edb042bfef0189540c3bb81516a1bd8c1b68f8ef9f94098cda4160709b081df65df0fa4f331e516af6b232bb04eed5406a062c54ebbccb3a5f058b9e87d756881157e978f1dd5cc66e020fedaa6ebb881cf8ea837cf46943031592049e636449e6ef79c4ed33435f2c5e1c4ef487f962678c1f14636385e16e795c30c55087d191e8d3fb99b0e6687de38399c2c67850658c3d658c8d916787b896c79d2e18a5f562b77e3aac8ef0121e21567e0c178df048cf90798a6d094548588e981d9a60c943b23d4e8fc8510d732da7da0ac9a75a7ab9eed686277c2011b8bbb87477f1671f5cb9bef2ecdbab6f7effeed2b91e701e801b60d5e73f50f7ced9e355b1af8a7d15ba55b1af8a7d55ecab62ffff2af6618f1f246b825f39e1a92b7b03d41f8e524737cd832e622489bd652c2c1ca57eb8bff29affc5e9e76fbef5096b61b5967a3cabe709def01788e9121bbb39c571035f2a5b0b1fbcf083bb4be776180c49e96383e1a55adfc1c0216aff3129d22ab6b505a7bcf360b296ba54eb7beeb733cfbdeff1ffe3cacfdff0d6d72e4fbcb03c37193d43951e427b95bc4b4388789ce2614a853ca308aa86780e2639455344c82591203229a5b2f2ce8322d5ffb0dd5f09dd9b9d525f57d3f0c4f64ee1b649cb63beac5f653cb2dcec45505a02ef025833039efc2c377475b76669256eaa1cff5388ea808c7896634576274f192ac96723a1ce0178723892cb98ce58d1d43a75a6108b240b6d7c47a94be0ed885014f9e10d9e7a6417b581e8cd662d23b95b6b4f6434773c6c728948c780d1d6adb946bce4b6f49afd439adcea447ba3566910954c9c6c278958823c35a0b5c24c2c6e99853811ba4e821e3034f56bcf79e05d1fd203557454d15145c7163aeafe78a0075c015539aa02ae0ab8cf037033a026c89cf0d495c7c200ebd24890242843c4f28865b04d8b0c0f1919c90cc3333cc389bcc8638d46788c46d8d6549a0dfef9bb977f37858e9f03fa3a564d258b1d5b6db6c69c1187d879629f2d380e369c34764b1669b6cf166ccdc199bcd3bc39a3c6723923a69899cd29f5fe0e24599619568608214160f0b657fb5cc575fee3ddf5dd429667912833883971e424f837000000ffff010000ffffcf9b148a981f0000'
    res = 解析直播间广播数据(content)
    print(res)
